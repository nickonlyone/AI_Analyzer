<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialog Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .upload-section { margin: 20px 0; padding: 20px; border: 2px dashed #ccc; }
        .results-section { margin-top: 30px; }
        .task-status { padding: 10px; margin: 5px 0; border-left: 4px solid #007bff; }
        .completed { border-color: #28a745; }
        .error { border-color: #dc3545; }
        .processing { border-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîä Dialog Analyzer</h1>

        <div class="upload-section">
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h3>
            <input type="file" id="fileInput" multiple accept="audio/*">
            <button onclick="uploadFiles()">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="uploadStatus"></div>
        </div>

        <div class="results-section">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
            <button onclick="downloadReport()">üìä –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç Excel</button>
            <div id="results"></div>
        </div>
    </div>

    <script>
        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('uploadStatus');

            if (!fileInput.files.length) {
                statusDiv.innerHTML = '<p style="color: red;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</p>';
                return;
            }

            const formData = new FormData();
            for (let file of fileInput.files) {
                formData.append('files', file);
            }

            try {
                statusDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
                const response = await fetch('/analyze-batch', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                statusDiv.innerHTML = `<p style="color: green;">${result.message}</p>`;

                // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                monitorTasks(result.task_ids);

            } catch (error) {
                statusDiv.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞: ${error}</p>`;
            }
        }

        async function monitorTasks(taskIds) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h4>–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á:</h4>';

            for (let taskId of taskIds) {
                const taskDiv = document.createElement('div');
                taskDiv.id = `task-${taskId}`;
                taskDiv.className = 'task-status';
                resultsDiv.appendChild(taskDiv);

                // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
                const interval = setInterval(async () => {
                    try {
                        const response = await fetch(`/status/${taskId}`);
                        const status = await response.json();

                        const taskElement = document.getElementById(`task-${taskId}`);
                        taskElement.innerHTML = `
                            <strong>${status.filename}</strong> -
                            –°—Ç–∞—Ç—É—Å: ${status.status} -
                            –ü—Ä–æ–≥—Ä–µ—Å—Å: ${status.progress || 0}%
                            ${status.error ? `<br>–û—à–∏–±–∫–∞: ${status.error}` : ''}
                        `;

                        taskElement.className = `task-status ${status.status}`;

                        if (status.status === 'completed' || status.status === 'error') {
                            clearInterval(interval);
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                    }
                }, 2000);
            }
        }

        async function downloadReport() {
            try {
                const response = await fetch('/download-report');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'dialogs_analysis_summary.xlsx';
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('–û—Ç—á–µ—Ç –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞: ' + error);
            }
        }
    </script>
</body>
</html>
